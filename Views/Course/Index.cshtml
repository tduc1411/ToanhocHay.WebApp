@using ToanHocHay.WebApp.Models.DTOs
@model ToanHocHay.WebApp.Models.DTOs.CurriculumDto

@{
    ViewData["Title"] = "Hệ thống Bài giảng";
    var filterType = Context.Request.Query["type"].ToString();
}

@* --- 1. HERO SECTION --- *@

<section class="relative bg-gradient-to-br from-blue-700 via-indigo-700 to-purple-800 text-white py-16 overflow-hidden">
    <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
    <div class="absolute -top-24 -right-24 w-96 h-96 bg-white opacity-10 rounded-full blur-[100px] animate-pulse"></div>

    <div class="container mx-auto px-4 relative z-10">
        <div class="max-w-4xl mx-auto text-center">
            <span class="inline-block bg-white/20 backdrop-blur-sm text-white text-xs font-black px-4 py-2 rounded-full mb-6 border border-white/30 tracking-widest uppercase">
                <i class="fa-solid fa-graduation-cap mr-2"></i> @(Model?.CurriculumName ?? "Hệ sinh thái ToanHocHay")
            </span>
            <h1 class="text-4xl md:text-6xl font-black mb-6 leading-tight">
                Chinh phục Toán học <br />
                <span class="text-yellow-300">Theo lộ trình riêng</span>
            </h1>
            <p class="text-lg md:text-xl text-blue-100 max-w-2xl leading-relaxed font-medium mx-auto">
                <span class="text-300">Hệ thống bài giảng AI cá nhân hóa giúp bạn lấp đầy lỗ hổng kiến thức và tối ưu hóa thời gian học tập.</span>
            </p>
        </div>
    </div>
</section>

@* --- 2. THANH ĐIỀU KHIỂN (Search & Sort) --- *@

<section class="bg-white border-b border-gray-100 sticky top-[64px] z-40 shadow-sm transition-all duration-300">
    <div class="container mx-auto px-4 py-4">
        <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
            <div class="w-full md:w-1/2 relative group">
                <input type="text" id="lessonSearch" onkeyup="filterLessons()" placeholder="Tìm tên bài học..."
                       class="w-full pl-12 pr-4 py-4 rounded-2xl border border-gray-100 bg-gray-50 focus:bg-white focus:border-blue-600 focus:ring-4 focus:ring-blue-50 outline-none transition-all font-bold text-sm">
                <i class="fa-solid fa-search absolute left-5 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-blue-600 transition-colors"></i>
            </div>
        </div>
    </div>


</section>

<section class="container mx-auto px-4 py-12">
    <div class="flex flex-col lg:flex-row gap-10">

        @* --- 3. BỘ LỌC SIDEBAR --- *@
        <aside class="w-full lg:w-1/4">
            <div class="bg-white rounded-[2.5rem] shadow-2xl shadow-slate-200/60 border border-gray-100 overflow-hidden sticky top-[150px] z-30">
                <div class="bg-slate-900 text-white p-6">
                    <h3 class="font-black flex items-center gap-3 uppercase text-[10px] tracking-[0.2em]">
                        <i class="fa-solid fa-sliders text-blue-400"></i> Lọc thông minh
                    </h3>
                </div>

                <div class="p-8 space-y-10">
                    <div>
                        <h4 class="font-black text-[10px] text-slate-400 mb-5 uppercase tracking-widest flex justify-between">
                            Độ khó <i class="fa-solid fa-chevron-down"></i>
                        </h4>
                        <div class="space-y-4" id="difficultyFilters">
                            <label class="flex items-center gap-3 cursor-pointer group">
                                <input type="checkbox" value="Easy" onchange="filterLessons()" class="difficulty-checkbox w-6 h-6 text-blue-600 rounded-lg border-gray-200" checked>
                                <span class="text-sm font-black text-slate-600 group-hover:text-blue-600 flex items-center transition">
                                    <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Cơ bản
                                </span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer group">
                                <input type="checkbox" value="Medium" onchange="filterLessons()" class="difficulty-checkbox w-6 h-6 text-blue-600 rounded-lg border-gray-200">
                                <span class="text-sm font-black text-slate-600 group-hover:text-blue-600 flex items-center transition">
                                    <span class="w-2 h-2 rounded-full bg-yellow-500 mr-2"></span> Trung bình
                                </span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer group">
                                <input type="checkbox" value="Hard" onchange="filterLessons()" class="difficulty-checkbox w-6 h-6 text-blue-600 rounded-lg border-gray-200">
                                <span class="text-sm font-black text-slate-600 group-hover:text-blue-600 flex items-center transition">
                                    <span class="w-2 h-2 rounded-full bg-red-500 mr-2"></span> Nâng cao
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="p-6 bg-slate-50">
                    <button onclick="resetFilters()" class="w-full bg-white text-slate-900 hover:bg-slate-900 hover:text-white font-black py-4 rounded-2xl transition-all text-xs uppercase tracking-widest border border-slate-200 shadow-sm">
                        Làm mới bộ lọc
                    </button>
                </div>
            </div>
        </aside>

        @* --- 4. DANH SÁCH BÀI HỌC --- *@
        <main class="flex-1">
            <div class="bg-blue-50 rounded-[2rem] p-6 mb-10 border border-blue-100 flex items-center justify-between shadow-sm">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-blue-600 shadow-sm">
                        <i class="fa-solid fa-bullseye text-xl"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-black text-blue-600 uppercase tracking-[0.1em]">Kết quả học tập</p>
                        <p class="text-sm text-slate-700 font-bold">
                            Chương trình có <span class="text-blue-600">@Model.Chapters.Count</span> chương và
                            <span id="found-count" class="text-blue-600">0</span> bài học
                        </p>
                    </div>
                </div>
            </div>

            <div id="chapter-container">
                @if (Model?.Chapters != null && Model.Chapters.Any())
                {
                    @foreach (var chapter in Model.Chapters.OrderBy(c => c.OrderIndex))
                    {
                        var chapterId = $"chapter-{chapter.ChapterId}";
                        <div class="chapter-block bg-white rounded-[2.5rem] shadow-xl shadow-slate-200/40 border border-gray-100 mb-10 overflow-hidden group">
                            @* Header của Chương *@
                            <div class="bg-white p-8 cursor-pointer border-b border-gray-50 hover:bg-slate-50 transition" onclick="toggleChapter('@chapterId')">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-6">
                                        <div class="w-16 h-16 bg-blue-600 text-white rounded-3xl flex items-center justify-center text-2xl shadow-lg shadow-blue-200">
                                            <i class="fa-solid fa-layer-group"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-2xl font-black text-slate-900 tracking-tight">@chapter.ChapterName</h3>
                                            <p class="text-sm text-slate-400 font-bold mt-1">
                                                @(chapter.Topics?.Count() ?? 0) bài học
                                            </p>
                                        </div>
                                    </div>
                                    <i class="fa-solid fa-chevron-down text-xl text-slate-300 transition-transform duration-500" id="@(chapterId)-icon"></i>
                                </div>
                            </div>

                            @* Danh sách bài học bên trong Chương *@
                            <div id="@chapterId" class="divide-y divide-gray-50 lesson-list" style="display:none">
                                @if (chapter.Topics != null && chapter.Topics.Any())
                                {
                                    @foreach (var topic in chapter.Topics.OrderBy(t => t.OrderIndex))
                                    {
                                        <div class="bg-slate-50/80 px-8 py-3 text-[10px] font-black text-blue-500 uppercase tracking-widest border-y border-gray-100">
                                            <i class="fa-solid fa-book-open mr-2"></i> CHỦ ĐỀ: @topic.TopicName
                                        </div>
                                        @* CHỈ HIỂN THỊ CHỦ ĐỀ NẾU CÓ BÀI HỌC BÊN TRONG *@
                                        @if (topic.Lessons != null && topic.Lessons.Any())
                                        {
                                            @foreach (var lesson in topic.Lessons.OrderBy(l => l.OrderIndex))
                                            {
                                                <div class="lesson-card p-6 flex items-center gap-6 group/lesson hover:bg-blue-50/30 transition-all"
                                                     data-name="@lesson.LessonName" data-difficulty="Easy">
                                                    <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center group-hover/lesson:bg-blue-600 group-hover/lesson:text-white transition-all shadow-sm">
                                                        <i class="fa-solid fa-play"></i>
                                                    </div>
                                                    <div class="flex-1">
                                                        <h4 class="font-black text-slate-800 text-lg group-hover/lesson:text-blue-600 transition">@lesson.LessonName</h4>
                                                        <div class="flex items-center gap-4 mt-1">
                                                            <p class="text-[11px] font-black text-slate-400 uppercase flex items-center gap-1">
                                                                <i class="fa-regular fa-clock"></i> @lesson.DurationMinutes PHÚT
                                                            </p>
                                                            <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                                                            <p class="text-[11px] font-black text-green-500 uppercase">CƠ BẢN</p>
                                                        </div>
                                                    </div>
                                                    <a href="/Course/Learning/@lesson.LessonId" class="px-6 py-2.5 bg-slate-900 text-white rounded-xl font-black text-[10px] uppercase opacity-0 group-hover/lesson:opacity-100 transition-all shadow-lg hover:scale-105">Học ngay</a>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="px-8 py-6 text-sm text-slate-400 italic bg-white">
                                                Chưa có bài học trong chủ đề này
                                            </div>
                                        }
                                    }
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center py-20 bg-white rounded-[2.5rem] border border-dashed border-gray-300">
                        <i class="fa-solid fa-box-open text-5xl text-gray-200 mb-4"></i>
                        <p class="text-slate-400 font-bold">Dữ liệu bài giảng đang được cập nhật...</p>
                    </div>
                }
            </div>
        </main>
    </div>
</section>

@section Scripts {
    <script>
        function toggleChapter(chapterId) {
            const element = document.getElementById(chapterId);
            const icon = document.getElementById(chapterId + '-icon');

            // Sử dụng max-height để tạo hiệu ứng mượt mà (nếu muốn) hoặc đơn giản là d-none
            if (element.style.display === 'none') {
                element.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                element.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

                function filterLessons() {
            const searchQuery = document.getElementById('lessonSearch').value.toLowerCase();
            const checkedBoxes = document.querySelectorAll('.difficulty-checkbox:checked');
            const selectedDifficulties = Array.from(checkedBoxes).map(cb => cb.value);
            const chapters = document.querySelectorAll('.chapter-block');
            let totalFound = 0;

            chapters.forEach(chapter => {
                const lessons = chapter.querySelectorAll('.lesson-card');
                let chapterVisibleLessons = 0;

                lessons.forEach(lesson => {
                    const name = (lesson.getAttribute('data-name') || "").toLowerCase();
                    const difficulty = lesson.getAttribute('data-difficulty') || "Easy"; // Lấy difficulty từ attr

                    const matchSearch = name.includes(searchQuery);
                    const matchDifficulty = selectedDifficulties.length === 0 || selectedDifficulties.includes(difficulty);

                    if (matchSearch && matchDifficulty) {
                        lesson.style.display = 'flex';
                        chapterVisibleLessons++;
                        totalFound++;
                    } else {
                        lesson.style.display = 'none';
                    }
                });

                // Hiện/Ẩn chương dựa trên bài học tìm thấy
                // chapter.style.display = chapterVisibleLessons > 0 ? 'block' : 'none';
            });

            document.getElementById('found-count').innerText = totalFound;
        }

        

        function resetFilters() {
            document.getElementById('lessonSearch').value = '';
            document.querySelectorAll('.difficulty-checkbox').forEach((cb, index) => {
                cb.checked = (index === 0);
            });
            filterLessons();
        }

        // Tự động chạy khi trang web tải xong
        document.addEventListener('DOMContentLoaded', function() {
            filterLessons();
        });
    </script>
}

}