@using ToanHocHay.WebApp.Models.DTOs
@model ToanHocHay.WebApp.Models.DTOs.LessonDto

@{
    ViewData["Title"] = Model.LessonName;
    // Lấy danh sách bài học liên quan từ ViewBag (đã ép kiểu)
    var relatedLessons = ViewBag.RelatedLessons as IEnumerable<LessonDto> ?? new List<LessonDto>();
}

<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col lg:flex-row gap-8">

        @* --- 1. CỘT CHÍNH: NỘI DUNG BÀI HỌC --- *@
        <div class="w-full lg:w-3/4">
            @* Header bài học *@
            <nav class="flex mb-4 text-slate-400 text-sm font-bold uppercase tracking-widest">
                <a href="/Course" class="hover:text-blue-600">Khóa học</a>
                <span class="mx-2">/</span>
                <span class="text-slate-600">@Model.LessonName</span>
            </nav>

            <h1 class="text-4xl font-black text-slate-900 mb-8">@Model.LessonName</h1>

            <div class="lesson-main-content space-y-8">
                @if (Model.Contents != null && Model.Contents.Any())
                {
                    @foreach (var block in Model.Contents.OrderBy(c => c.OrderIndex))
                    {
                        @switch (block.BlockType)
                        {
                            case LessonBlockType.Heading:
                                <h2 class="text-2xl font-black text-slate-800 pt-6 border-b-4 border-blue-50 pb-2">@block.ContentText</h2>
                                break;

                            case LessonBlockType.Video:
                                <div class="aspect-video rounded-[2rem] overflow-hidden shadow-2xl my-8 bg-black border-8 border-slate-900">
                                    <iframe class="w-full h-full" src="@block.ContentUrl" frameborder="0"
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                </div>
                                break;

                            case LessonBlockType.Text:
                                <div class="text-slate-700 leading-relaxed text-xl font-medium">@block.ContentText</div>
                                break;

                            case LessonBlockType.Definition:
                                <div class="bg-blue-50 border-l-8 border-blue-500 p-8 rounded-r-[2rem] shadow-sm relative overflow-hidden">
                                    <div class="absolute top-0 right-0 p-4 opacity-10 text-4xl text-blue-500">
                                        <i class="fa-solid fa-book"></i>
                                    </div>
                                    <span class="inline-block bg-blue-500 text-white text-[10px] font-black px-3 py-1 rounded-full uppercase mb-4">Khái niệm cần nhớ</span>
                                    <div class="text-slate-900 text-xl font-bold leading-snug">@block.ContentText</div>
                                </div>
                                break;

                            case LessonBlockType.Example:
                                <div class="bg-emerald-50 border-l-8 border-emerald-500 p-8 rounded-r-[2rem] shadow-sm">
                                    <span class="inline-block bg-emerald-500 text-white text-[10px] font-black px-3 py-1 rounded-full uppercase mb-4">Ví dụ mẫu</span>
                                    <div class="text-slate-800 italic text-lg leading-relaxed">@block.ContentText</div>
                                </div>
                                break;

                            case LessonBlockType.Formula:
                                <div class="bg-slate-900 text-white p-10 rounded-[2.5rem] text-center shadow-xl my-6">
                                    <div class="text-3xl md:text-4xl text-yellow-300 overflow-x-auto py-2">
                                        \[ @block.ContentText \]
                                    </div>
                                    <p class="text-[10px] text-slate-500 uppercase mt-4 tracking-widest font-black">Công thức toán học</p>
                                </div>
                                break;

                            case LessonBlockType.Note:
                                <div class="bg-amber-50 border-l-8 border-amber-400 p-8 rounded-r-[2rem]">
                                    <div class="flex items-center gap-3 text-amber-700 font-black uppercase text-xs mb-3">
                                        <i class="fa-solid fa-triangle-exclamation text-lg"></i> Chú ý quan trọng
                                    </div>
                                    <div class="text-slate-800 text-lg">@block.ContentText</div>
                                </div>
                                break;
                        }
                    }
                }
                else
                {
                    <div class="py-32 text-center bg-slate-50 rounded-[3rem] border-4 border-dashed border-slate-200">
                        <i class="fa-solid fa-feather-pointed text-6xl text-slate-200 mb-6"></i>
                        <h3 class="text-xl font-bold text-slate-400">Nội dung bài học đang được biên soạn...</h3>
                        <p class="text-slate-400 text-sm mt-2">Vui lòng quay lại sau bạn nhé!</p>
                    </div>
                }
            </div>
        </div>

        @* --- 2. SIDEBAR: DANH SÁCH BÀI HỌC CÙNG CHỦ ĐỀ --- *@
        <aside class="w-full lg:w-1/4">
            <div class="sticky top-24 bg-white rounded-[2.5rem] shadow-2xl shadow-slate-200 border border-slate-100 overflow-hidden">
                <div class="bg-slate-900 p-6 text-white">
                    <h4 class="font-black text-xs uppercase tracking-[0.2em] flex items-center gap-2">
                        <i class="fa-solid fa-list-ul text-blue-400"></i> Lộ trình bài học
                    </h4>
                </div>
                <div class="max-h-[70vh] overflow-y-auto custom-scrollbar">
                    @foreach (var item in relatedLessons.OrderBy(l => l.OrderIndex))
                    {
                        bool isCurrent = item.LessonId == Model.LessonId;
                        <a href="/Course/Learning/@item.LessonId"
                           class="group flex items-center gap-4 p-5 transition-all border-b border-slate-50 @(isCurrent ? "bg-blue-50" : "hover:bg-slate-50")">
                            <div class="w-10 h-10 shrink-0 rounded-2xl flex items-center justify-center text-sm font-black transition-all
                                    @(isCurrent ? "bg-blue-600 text-white shadow-lg shadow-blue-200" : "bg-slate-100 text-slate-400 group-hover:bg-white group-hover:shadow-md")">
                                @(isCurrent ? "" : item.OrderIndex.ToString())
                                @if (isCurrent)
                                {
                                    <i class="fa-solid fa-play"></i>
                                }
                            </div>
                            <span class="text-sm font-black leading-tight @(isCurrent ? "text-blue-700" : "text-slate-600 group-hover:text-slate-900")">
                                @item.LessonName
                            </span>
                        </a>
                    }
                </div>
            </div>
        </aside>
    </div>
</div>

@section Scripts {
    @* MathJax để render công thức đẹp *@
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: #cbd5e1;
            }
    </style>
}